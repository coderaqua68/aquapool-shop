var Ee=Object.defineProperty;var _e=(o,s)=>{for(var r in s)Ee(o,r,{get:s[r],enumerable:!0})};import W from"express";import{createServer as Ke}from"http";import{Pool as Me,neonConfig as Le}from"@neondatabase/serverless";import{drizzle as Oe}from"drizzle-orm/neon-serverless";import Ue from"ws";var se={};_e(se,{categories:()=>C,consultations:()=>Y,insertCategorySchema:()=>Ne,insertConsultationSchema:()=>re,insertOrderSchema:()=>te,insertProductSchema:()=>ee,insertSiteSettingSchema:()=>qe,insertTelegramAdminSchema:()=>Fe,orders:()=>L,products:()=>n,siteSettings:()=>T,telegramAdmins:()=>A});import{pgTable as q,text as u,varchar as B,serial as F,integer as _,boolean as z,decimal as Q,timestamp as N}from"drizzle-orm/pg-core";import{createInsertSchema as M}from"drizzle-zod";var n=q("products",{id:F("id").primaryKey(),sku:u("sku").unique().notNull(),name:u("name").notNull(),slug:u("slug").unique().notNull(),description:u("description").notNull(),composition:u("composition"),shortDescription:u("short_description"),price:Q("price",{precision:10,scale:2}).notNull(),originalPrice:Q("original_price",{precision:10,scale:2}),category:u("category").notNull(),subcategory:u("subcategory"),brand:u("brand"),volume:u("volume"),imageUrl:u("image_url").notNull(),images:u("images").array(),specifications:u("specifications").notNull(),inStock:z("in_stock").default(!0),isPopular:z("is_popular").default(!1),isNew:z("is_new").default(!1),discount:_("discount").default(0),rating:Q("rating",{precision:2,scale:1}).default("0"),reviewCount:_("review_count").default(0),weight:u("weight"),dimensions:u("dimensions"),material:u("material"),color:u("color"),frameType:u("frame_type"),pumpType:u("pump_type"),pumpCapacity:u("pump_capacity"),shape:u("shape"),installationType:u("installation_type"),countryOrigin:u("country_origin")}),C=q("categories",{id:F("id").primaryKey(),name:u("name").notNull(),slug:u("slug").notNull().unique(),description:u("description"),imageUrl:u("image_url"),productCount:_("product_count").default(0),parentId:_("parent_id").references(()=>C.id),level:_("level").default(0),sortOrder:_("sort_order").default(0)}),L=q("orders",{id:F("id").primaryKey(),customerName:u("customer_name").notNull(),customerEmail:u("customer_email"),customerPhone:u("customer_phone").notNull(),deliveryAddress:u("delivery_address"),deliveryMethod:u("delivery_method").notNull(),paymentMethod:u("payment_method").notNull(),items:u("items").notNull(),totalAmount:Q("total_amount",{precision:10,scale:2}).notNull(),status:u("status").default("pending"),notes:u("notes"),createdAt:N("created_at").defaultNow()}),Y=q("consultations",{id:F("id").primaryKey(),name:u("name").notNull(),phone:u("phone").notNull(),email:u("email"),message:u("message"),status:u("status").default("pending"),createdAt:N("created_at").defaultNow()}),ee=M(n).omit({id:!0}),Ne=M(C).omit({id:!0}),te=M(L).omit({id:!0,createdAt:!0}),re=M(Y).omit({id:!0,createdAt:!0,status:!0}),T=q("site_settings",{id:F("id").primaryKey(),key:B("key").notNull().unique(),value:u("value"),description:u("description"),category:B("category").notNull().default("general"),isActive:z("is_active").default(!0),createdAt:N("created_at").defaultNow(),updatedAt:N("updated_at").defaultNow()}),qe=M(T).omit({id:!0,createdAt:!0,updatedAt:!0}),A=q("telegram_admins",{id:F("id").primaryKey(),chatId:B("chat_id",{length:50}).notNull().unique(),name:B("name",{length:100}).notNull(),username:B("username",{length:50}),isActive:z("is_active").default(!0),addedAt:N("added_at").defaultNow(),lastNotified:N("last_notified")}),Fe=M(A).omit({id:!0,addedAt:!0,lastNotified:!0});Le.webSocketConstructor=Ue;if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");var De=new Me({connectionString:process.env.DATABASE_URL}),p=Oe({client:De,schema:se});import{eq as P,and as oe,gte as Be,lte as ze,desc as ne,ilike as b,or as R,sql as H}from"drizzle-orm";var ie=class{async getProducts(s){let r=p.select().from(n);if(s){let t=[];if(s.category){let[e]=await p.select().from(C).where(P(C.slug,s.category));if(e){let i=await p.select().from(C).where(P(C.parentId,e.id));if(i.length>0){let a=i.map(l=>l.slug).map(l=>P(n.category,l));t.push(R(...a))}else t.push(P(n.category,s.category))}}if(s.minPrice!==void 0&&t.push(Be(n.price,s.minPrice.toString())),s.maxPrice!==void 0&&t.push(ze(n.price,s.maxPrice.toString())),s.search){let e=s.search.toLowerCase();t.push(R(b(n.name,`%${e}%`),b(n.sku,`%${e}%`),b(n.brand,`%${e}%`),b(n.description,`%${e}%`),b(n.specifications,`%${e}%`)))}if(s.dimensions){let e=s.dimensions.trim();e&&t.push(R(b(n.name,`%${e}%`),b(n.specifications,`%${e}%`)))}t.length>0&&(r=r.where(oe(...t)))}return await r.orderBy(ne(n.id))}async getProduct(s){let[r]=await p.select().from(n).where(P(n.id,s));return r}async getProductBySlug(s){let[r]=await p.select().from(n).where(P(n.slug,s));return r}async getPopularProducts(){return await p.select().from(n).where(P(n.isPopular,!0)).orderBy(ne(n.rating)).limit(8)}async getSearchSuggestions(s){let r=s.toLowerCase().trim(),t=[];if(r.length<2)return t;let e=await p.select({id:n.id,name:n.name,sku:n.sku,slug:n.slug,price:n.price,imageUrl:n.imageUrl,brand:n.brand}).from(n).where(P(n.sku,r.toUpperCase())).limit(5);e.forEach(c=>{t.push({type:"product",text:`${c.name} (\u0430\u0440\u0442. ${c.sku})`,value:c.slug,sku:c.sku,price:c.price,image:c.imageUrl||void 0})}),e.length===0&&/^\d/.test(r)&&(await p.select({id:n.id,name:n.name,sku:n.sku,slug:n.slug,price:n.price,imageUrl:n.imageUrl,brand:n.brand}).from(n).where(b(n.sku,`${r}%`)).limit(5)).forEach(a=>{t.push({type:"product",text:`${a.name} (\u0430\u0440\u0442. ${a.sku})`,value:a.slug,sku:a.sku,price:a.price,image:a.imageUrl||void 0})});let i=r.match(/(\d+)\s*[xх×]\s*(\d+)(?:\s*[xх×]\s*(\d+))?/);if(i&&e.length===0){let[,c,a,l]=i,S=[];S.push(b(n.name,`%${c} x ${a}%`),b(n.name,`%${c}x${a}%`),b(n.name,`%${c} \u0445 ${a}%`),b(n.name,`%${c}\u0445${a}%`)),l&&S.push(b(n.name,`%${c} x ${a} x ${l}%`),b(n.name,`%${c}x${a}x${l}%`),b(n.name,`%${c} \u0445 ${a} \u0445 ${l}%`),b(n.name,`%${c}\u0445${a}\u0445${l}%`)),(await p.select({id:n.id,name:n.name,sku:n.sku,slug:n.slug,price:n.price,imageUrl:n.imageUrl,brand:n.brand}).from(n).where(R(...S)).limit(3)).forEach(x=>{t.push({type:"product",text:`${x.name} (\u0430\u0440\u0442. ${x.sku})`,value:x.slug,sku:x.sku,price:x.price,image:x.imageUrl||void 0})})}return t.length<8&&(await p.select({id:n.id,name:n.name,sku:n.sku,slug:n.slug,price:n.price,imageUrl:n.imageUrl,brand:n.brand}).from(n).where(oe(b(n.name,`%${r}%`),...t.map(a=>H`${n.sku} != ${a.sku}`))).limit(8-t.length)).forEach(a=>{t.push({type:"product",text:`${a.name} (\u0430\u0440\u0442. ${a.sku})`,value:a.slug,sku:a.sku,price:a.price,image:a.imageUrl||void 0})}),t.length<8&&(await p.select({id:n.id,name:n.name,sku:n.sku,slug:n.slug,price:n.price,imageUrl:n.imageUrl,brand:n.brand}).from(n).where(oe(b(n.brand,`%${r}%`),...t.map(a=>H`${n.sku} != ${a.sku}`))).limit(8-t.length)).forEach(a=>{t.push({type:"product",text:`${a.name} (\u0430\u0440\u0442. ${a.sku})`,value:a.slug,sku:a.sku,price:a.price,image:a.imageUrl||void 0})}),t}async createProduct(s){let[r]=await p.insert(n).values(s).returning();return r}async updateProduct(s,r){let[t]=await p.update(n).set(r).where(P(n.id,s)).returning();return t}async updateProductPriceBySku(s,r,t){let e={price:r.toString()};t!==void 0&&(e.originalPrice=t.toString());let[i]=await p.update(n).set(e).where(P(n.sku,s)).returning();return i}async deleteProduct(s){return(await p.delete(n).where(P(n.id,s))).rowCount>0}async getCategories(){return await p.select().from(C)}async getMainCategories(){return await p.select().from(C).where(H`parent_id IS NULL`)}async getCategoryStats(s){let e=({"karkasnye-basseyny":["intex-karkasnye","bestway-karkasnye"],"morozostojkie-basseyny":["laguna","magic-pool","summer-fun","gre"],"dzjakuzi-intex":["dzjakuzi-intex"],"dzjakuzi-bestway":["dzjakuzi-bestway"],"zapasnye-chashi":["chashi-laguna","chashi-intex","chashi-bestway","chashi-gre","chashi-azuro","chashi-atlantic-pool","chashi-larimar"]}[s]||[s]).map(l=>P(n.category,l)),i=e.length===1?e[0]:R(...e),a=(await p.select({count:H`count(*)::int`,minPrice:H`min(${n.price}::int)::int`}).from(n).where(i))[0];return!a||a.count===0?{count:0,minPrice:0}:{count:a.count,minPrice:a.minPrice||0}}async createCategory(s){let[r]=await p.insert(C).values(s).returning();return r}async createOrder(s){let[r]=await p.insert(L).values(s).returning();return r}async getOrder(s){let[r]=await p.select().from(L).where(P(L.id,s));return r}async createConsultation(s){let[r]=await p.insert(Y).values(s).returning();return r}async getSiteSettings(){return await p.select().from(T).orderBy(T.category,T.key)}async getSiteSetting(s){let[r]=await p.select().from(T).where(P(T.key,s));return r}async createSiteSetting(s){let[r]=await p.insert(T).values(s).returning();return r}async updateSiteSetting(s,r){let[t]=await p.update(T).set({...r,updatedAt:new Date}).where(P(T.id,s)).returning();return t}async getTelegramAdmins(){return await p.select().from(A).orderBy(ne(A.addedAt))}async createTelegramAdmin(s){let[r]=await p.insert(A).values(s).returning();return r}async deleteTelegramAdmin(s){return(await p.delete(A).where(P(A.id,s))).rowCount>0}async toggleTelegramAdmin(s,r){let[t]=await p.update(A).set({isActive:r}).where(P(A.id,s)).returning();return t}async updateLastNotified(s){await p.update(A).set({lastNotified:new Date}).where(P(A.chatId,s))}},f=new ie;import Re from"node-telegram-bot-api";var He="7550930591:AAHZHqOnklv8EFkID5XaTkgzCrGwhY3Ex7M",fe=new Re(He,{polling:!1});async function ae(){try{return(await f.getTelegramAdmins()).filter(s=>s.isActive).map(s=>s.chatId)}catch(o){return console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u043E\u0432 \u0438\u0437 \u0411\u0414:",o),(process.env.TELEGRAM_ADMIN_CHAT_IDS||"5696137293").split(",").map(r=>r.trim()).filter(Boolean)}}async function ye(o,s){let r=await ae(),t=[];for(let e of r)try{await fe.sendMessage(e,o,s),t.push({chatId:e,success:!0}),console.log(`\u0421\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u0435 \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u0447\u0430\u0442 ${e}`),await f.updateLastNotified(e)}catch(i){console.error(`\u041E\u0448\u0438\u0431\u043A\u0430 \u043E\u0442\u043F\u0440\u0430\u0432\u043A\u0438 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u044F \u0432 \u0447\u0430\u0442 ${e}:`,i),t.push({chatId:e,success:!1,error:i})}return t}async function he(o){try{let s=`
\u{1F514} <b>\u041D\u043E\u0432\u0430\u044F \u0437\u0430\u044F\u0432\u043A\u0430 \u043D\u0430 \u043E\u0431\u0440\u0430\u0442\u043D\u0443\u044E \u0441\u0432\u044F\u0437\u044C</b>

\u{1F464} <b>\u0418\u043C\u044F:</b> ${o.name}
\u{1F4DE} <b>\u0422\u0435\u043B\u0435\u0444\u043E\u043D:</b> ${o.phone}
\u{1F4AC} <b>\u0421\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u0435:</b> ${o.message}

\u23F0 <b>\u0412\u0440\u0435\u043C\u044F:</b> ${new Date().toLocaleString("ru-RU",{timeZone:"Europe/Moscow",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})} \u041C\u0421\u041A
    `;return await ye(s,{parse_mode:"HTML"}),{success:!0}}catch(s){return console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043E\u0442\u043F\u0440\u0430\u0432\u043A\u0438 \u0432 Telegram:",s),{success:!1,error:s}}}async function Se(o){try{let s=o.items.map((t,e)=>`${e+1}. <b>${t.name}</b>
   \u{1F4E6} \u0410\u0440\u0442\u0438\u043A\u0443\u043B: ${t.sku}
   \u{1F4CA} \u041A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E: ${t.quantity} \u0448\u0442.
   \u{1F4B0} \u0426\u0435\u043D\u0430: ${t.price} \u20BD`).join(`

`),r=`
\u{1F6D2} <b>\u041D\u041E\u0412\u042B\u0419 \u0417\u0410\u041A\u0410\u0417 #${o.orderId}</b>

\u{1F464} <b>\u041F\u043E\u043A\u0443\u043F\u0430\u0442\u0435\u043B\u044C:</b>
\u2022 \u0418\u043C\u044F: ${o.customerName}
\u2022 \u0422\u0435\u043B\u0435\u0444\u043E\u043D: ${o.phone}
\u2022 Email: ${o.email}

\u{1F4E6} <b>\u0422\u043E\u0432\u0430\u0440\u044B:</b>
${s}

\u{1F4B5} <b>\u041E\u0431\u0449\u0430\u044F \u0441\u0443\u043C\u043C\u0430:</b> ${o.totalAmount} \u20BD

\u{1F69A} <b>\u0414\u043E\u0441\u0442\u0430\u0432\u043A\u0430:</b> ${o.deliveryMethod}
\u{1F4CD} <b>\u0410\u0434\u0440\u0435\u0441:</b> ${o.deliveryAddress}

\u{1F4B3} <b>\u041E\u043F\u043B\u0430\u0442\u0430:</b> ${o.paymentMethod}

\u23F0 <b>\u0412\u0440\u0435\u043C\u044F \u0437\u0430\u043A\u0430\u0437\u0430:</b> ${new Date().toLocaleString("ru-RU",{timeZone:"Europe/Moscow",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})} \u041C\u0421\u041A

\u{1F4DE} <b>\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u0435:</b> \u0421\u0432\u044F\u0436\u0438\u0442\u0435\u0441\u044C \u0441 \u043A\u043B\u0438\u0435\u043D\u0442\u043E\u043C \u0434\u043B\u044F \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u044F \u0437\u0430\u043A\u0430\u0437\u0430
    `;return await ye(r,{parse_mode:"HTML"}),{success:!0}}catch(s){return console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043E\u0442\u043F\u0440\u0430\u0432\u043A\u0438 \u0437\u0430\u043A\u0430\u0437\u0430 \u0432 Telegram:",s),{success:!1,error:s}}}async function X(){try{let o=await fe.getMe(),s=await ae();return console.log("Telegram \u0431\u043E\u0442 \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D:",o.username),console.log(`\u041D\u0430\u0441\u0442\u0440\u043E\u0435\u043D\u043E ${s.length} \u043F\u043E\u043B\u0443\u0447\u0430\u0442\u0435\u043B\u0435\u0439 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0439:`,s.join(", ")),{success:!0,botInfo:o,adminChatIds:s,adminCount:s.length}}catch(o){return console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u044F \u043A Telegram \u0431\u043E\u0442\u0443:",o),{success:!1,error:o}}}async function Pe(){let o=await ae();return{chatIds:o,count:o.length,source:"database"}}import We from"node-fetch";import{JSDOM as Je}from"jsdom";function Ve(o){return o.toLowerCase().replace(/[а-яё]/g,s=>({\u0430:"a",\u0431:"b",\u0432:"v",\u0433:"g",\u0434:"d",\u0435:"e",\u0451:"e",\u0436:"zh",\u0437:"z",\u0438:"i",\u0439:"y",\u043A:"k",\u043B:"l",\u043C:"m",\u043D:"n",\u043E:"o",\u043F:"p",\u0440:"r",\u0441:"s",\u0442:"t",\u0443:"u",\u0444:"f",\u0445:"h",\u0446:"ts",\u0447:"ch",\u0448:"sh",\u0449:"sch",\u044A:"",\u044B:"y",\u044C:"",\u044D:"e",\u044E:"yu",\u044F:"ya"})[s]||s).replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").substring(0,100)}async function Ge(o){try{console.log(`Parsing product from: ${o}`);let s=await We(o,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);let r=await s.text(),e=new Je(r).window.document,c=(e.querySelector("h1")||e.querySelector(".product-title")||e.querySelector('[class*="title"]'))?.textContent?.trim()||"\u0422\u043E\u0432\u0430\u0440 \u0431\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",a="0",l=null;console.log("Looking for prices...");let S=[".product-item-price-current",".product-item-price",".price-current",".current-price",".price",'[class*="price"]'];for(let m of S){let y=e.querySelector(m);if(y){let d=y.textContent?.trim()||"";console.log(`Found price element (${m}): ${d}`);let g=d.match(/(\d+[\s,.]?\d*)/);if(g){a=g[1].replace(/[\s,.]/g,""),console.log(`Extracted current price: ${a}`);break}}}let j=[".product-item-price-old",".price-old",".old-price",".price-before"];for(let m of j){let y=e.querySelector(m);if(y){let d=y.textContent?.trim()||"";console.log(`Found old price element (${m}): ${d}`);let g=d.match(/(\d+[\s,.]?\d*)/);if(g){l=g[1].replace(/[\s,.]/g,""),console.log(`Extracted old price: ${l}`);break}}}if(a==="0"){console.log("No price found in specific elements, searching in all text...");let m=Array.from(e.querySelectorAll("*")),y=[/(\d+)\s*000\s*руб/,/(\d+)\s*руб/,/(\d{4,6})/];for(let d of m){let g=d.textContent?.trim()||"";for(let h of y){let pe=g.match(h);if(pe){let Z=pe[1];Z.length>=4&&(a==="0"?(a=Z,console.log(`Found price in text: ${a} from "${g}"`)):!l&&Z!==a&&(l=Z,console.log(`Found original price in text: ${l} from "${g}"`)))}}if(a!=="0"&&l)break}}console.log(`Final prices - current: ${a}, original: ${l}`);let x=`PROD-${Date.now()}`,le=e.querySelector(".product-item-detail-article span");if(le){let m=le.textContent?.trim();m&&(x=m,console.log(`Found SKU from HTML element: ${x}`))}else{let m=o.match(/artikul?[_-]([^\/]+)/);m?(x=m[1].replace(/-[^-]*$/,""),console.log(`Found SKU from URL: ${x}`)):console.log(`No SKU found, using generated: ${x}`)}let v="",J=!1,O="",ue=m=>m.replace(/<a[^>]*>(.*?)<\/a>/gi,"$1"),de=m=>m.replace(/<img[^>]*src="[^"]*ac672c30d0d9dc49688f1ab82d73261d[^"]*"[^>]*>/gi,'<img width="90" alt="\u0420\u0430\u0437\u043C\u0435\u0440 \u0443\u043F\u0430\u043A\u043E\u0432\u043A\u0438" src="/package-icon.png" height="82" align="left" style="margin-right: 15px" title="\u0420\u0430\u0437\u043C\u0435\u0440 \u0443\u043F\u0430\u043A\u043E\u0432\u043A\u0438">'),me=e.querySelector('[data-value="free-tab"] .toggle_content');if(me){let m=me.innerHTML?.trim()||"";O=ue(m),O=de(O),console.log(`Found composition: ${O.substring(0,100)}...`)}let ge=e.querySelector('[data-value="description"] .toggle_content');if(ge){let m=ge.innerHTML?.trim()||"";v=ue(m),v=de(v),J=!0,console.log(`Found main description: ${v.substring(0,100)}...`)}if(!J){let m=[".toggle_content",".product-item-detail-text",".product-description",".product-detail-description",'[class*="description"]'];for(let y of m){let d=Array.from(e.querySelectorAll(y));if(d.length>0&&(v=d.map(g=>g.innerHTML?.trim()).filter(Boolean).join(`

`),v&&v.length>10)){J=!0,console.log(`Found description from fallback selector ${y}: ${v.substring(0,100)}...`);break}}}(!J||v.length<50)&&(v=`<h2>${c}</h2>
<p>\u041A\u0430\u0447\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043A\u0430\u0440\u043A\u0430\u0441\u043D\u044B\u0439 \u0431\u0430\u0441\u0441\u0435\u0439\u043D \u043E\u0442 \u0438\u0437\u0432\u0435\u0441\u0442\u043D\u043E\u0433\u043E \u043F\u0440\u043E\u0438\u0437\u0432\u043E\u0434\u0438\u0442\u0435\u043B\u044F. \u041E\u0442\u043B\u0438\u0447\u043D\u043E\u0435 \u0440\u0435\u0448\u0435\u043D\u0438\u0435 \u0434\u043B\u044F \u0434\u0430\u0447\u0438 \u0438 \u0437\u0430\u0433\u043E\u0440\u043E\u0434\u043D\u043E\u0433\u043E \u0434\u043E\u043C\u0430.</p>

<h3>\u0412 \u043A\u043E\u043C\u043F\u043B\u0435\u043A\u0442 \u043F\u043E\u0441\u0442\u0430\u0432\u043A\u0438 \u0432\u0445\u043E\u0434\u0438\u0442:</h3>
<ul>
<li>\u041A\u0430\u0440\u043A\u0430\u0441\u043D\u044B\u0439 \u0431\u0430\u0441\u0441\u0435\u0439\u043D</li>
<li>\u041A\u0430\u0440\u0442\u0440\u0438\u0434\u0436\u043D\u044B\u0439 \u043D\u0430\u0441\u043E\u0441-\u0444\u0438\u043B\u044C\u0442\u0440</li>
<li>\u0424\u0438\u043B\u044C\u0442\u0440\u0443\u044E\u0449\u0438\u0439 \u043A\u0430\u0440\u0442\u0440\u0438\u0434\u0436</li>
<li>\u041B\u0435\u0441\u0442\u043D\u0438\u0446\u0430</li>
<li>\u0422\u0435\u043D\u0442 \u0434\u043B\u044F \u0431\u0430\u0441\u0441\u0435\u0439\u043D\u0430</li>
<li>\u0420\u0443\u043A\u043E\u0432\u043E\u0434\u0441\u0442\u0432\u043E \u043F\u043E \u044D\u043A\u0441\u043F\u043B\u0443\u0430\u0442\u0430\u0446\u0438\u0438</li>
</ul>

<p>\u0411\u0430\u0441\u0441\u0435\u0439\u043D \u0441\u043D\u0438\u0437\u0443 \u043E\u0431\u043E\u0440\u0443\u0434\u043E\u0432\u0430\u043D \u0441\u043B\u0438\u0432\u043D\u044B\u043C \u043A\u043B\u0430\u043F\u0430\u043D\u043E\u043C \u0434\u043B\u044F \u0443\u0434\u043E\u0431\u043D\u043E\u0433\u043E \u0441\u043B\u0438\u0432\u0430 \u0432\u043E\u0434\u044B. \u041C\u0435\u0442\u0430\u043B\u043B\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043A\u0430\u0440\u043A\u0430\u0441 \u0441\u043E\u0441\u0442\u043E\u0438\u0442 \u0438\u0437 \u0441\u043E\u0435\u0434\u0438\u043D\u0438\u0442\u0435\u043B\u044C\u043D\u044B\u0445 \u0443\u0433\u043E\u043B\u043A\u043E\u0432, \u0442\u0440\u0443\u0431\u043E\u043A-\u043F\u0435\u0440\u0435\u043C\u044B\u0447\u0435\u043A \u0438 \u0441\u0442\u043E\u0435\u043A. \u0412\u0441\u0435 \u0434\u0435\u0442\u0430\u043B\u0438 \u043E\u043A\u0440\u0430\u0448\u0435\u043D\u044B \u0438 \u0443\u0441\u0442\u043E\u0439\u0447\u0438\u0432\u044B \u043A \u0438\u0441\u0442\u0438\u0440\u0430\u043D\u0438\u044E.</p>`);let w={};Array.from(e.querySelectorAll(".product-item-detail-properties")).forEach(m=>{let y=m.querySelector(".product-item-detail-properties-name"),d=m.querySelector(".product-item-detail-properties-val");if(y&&d){let g=y.textContent?.trim()||"",h=d.textContent?.trim()||"";g&&h&&(w[g]=h)}}),Array.from(e.querySelectorAll(".product-item-detail-properties-group-property")).forEach(m=>{let y=m.querySelector(".product-item-detail-properties-group-property-name"),d=m.querySelector(".product-item-detail-properties-group-property-val");if(y&&d){let g=y.textContent?.trim()||"",h=d.textContent?.trim()||"";g&&h&&(w[g]=h)}});let E="Intex";c.toLowerCase().includes("bestway")?E="Bestway":c.toLowerCase().includes("intex")?E="Intex":w.\u0411\u0440\u0435\u043D\u0434&&(E=w.\u0411\u0440\u0435\u043D\u0434);let U="frame-pools";c.toLowerCase().includes("\u043D\u0430\u0434\u0443\u0432\u043D\u043E\u0439")?U="inflatable-pools":c.toLowerCase().includes("\u0434\u0435\u0442\u0441\u043A\u0438\u0439")?U="kids-pools":o.includes("karkasnye")&&(U="frame-pools");let V=c.match(/(\d+[,.]?\d*)\s*[xх×]\s*(\d+[,.]?\d*)\s*[xх×]?\s*(\d+[,.]?\d*)?/),G="",D="";if(V){let m=V[1].replace(",","."),y=V[2].replace(",","."),d=V[3]?.replace(",",".")||"";G=d?`${m} x ${y} x ${d}`:`${m} x ${y}`}if(w.\u041E\u0431\u044A\u0435\u043C)D=w.\u041E\u0431\u044A\u0435\u043C.replace(/[^\d]/g,"");else{let m=c.match(/(\d+[\s,.]?\d*)\s*л/);m&&(D=m[1].replace(/[\s,.]/g,""))}let k="/api/placeholder/400/400",Ie=[".main_product img",".main_product .img img",".catalog-block-item img",".product-item-detail-tabs-content img"];for(let m of Ie){let y=e.querySelector(m);if(y){let d=y.getAttribute("src");if(console.log(`Checking selector ${m}, found image: ${d}`),d&&d.includes("upload")&&!d.includes("thumb")&&!d.includes("small")&&!d.includes("watermark")){if(d.includes("2f8e6a1cfe55806934aa37cf1f43bb79")||d.includes("no_photo")||d.includes("placeholder")){console.log(`Skipping generic image: ${d}`);continue}d.startsWith("/")?k="https://intex-bassein.ru"+d:d.startsWith("http")&&(k=d),console.log(`Found image from main_product section (without watermark): ${k}`);break}}}if(k==="/api/placeholder/400/400"){let m=[".bx-pict-big img",".product-item-detail-picture img",".product-item-picture img",".product-pictures img",".product-gallery img:first-child",".main-image img",'img[itemprop="image"]',".bx-pict img"];for(let y of m){let d=e.querySelector(y);if(d){let g=d.getAttribute("src");if(g&&g.includes("upload")&&!g.includes("thumb")&&!g.includes("small")){if(g.includes("2f8e6a1cfe55806934aa37cf1f43bb79")||g.includes("no_photo")||g.includes("placeholder")){console.log(`Skipping generic image: ${g}`);continue}g.startsWith("/")?k="https://intex-bassein.ru"+g:g.startsWith("http")&&(k=g),console.log(`Found main product image via selector ${y}: ${k}`);break}}}if(k==="/api/placeholder/400/400"){console.log("No image found via selectors, scanning all images...");let y=Array.from(e.querySelectorAll("img"));console.log(`Found ${y.length} total images on page`);for(let d=0;d<y.length;d++){let g=y[d],h=g.getAttribute("src");if(console.log(`Image ${d}: ${h}`),h&&h.includes("upload")&&!h.includes("thumb")&&!h.includes("small")&&!h.includes("resize")){if(h.includes("2f8e6a1cfe55806934aa37cf1f43bb79")||h.includes("no_photo")||h.includes("placeholder")||h.includes("default")||g.getAttribute("alt")?.toLowerCase().includes("\u043B\u043E\u0433\u043E\u0442\u0438\u043F")){console.log(`Skipping generic image: ${h}`);continue}h.startsWith("/")?k="https://intex-bassein.ru"+h:h.startsWith("http")&&(k=h),console.log(`Found fallback product image: ${k}`);break}}}}let je=[G?`\u0420\u0430\u0437\u043C\u0435\u0440: ${G}`:"",D?`\u041E\u0431\u044A\u0435\u043C: ${D} \u043B`:"",E?`\u0411\u0440\u0435\u043D\u0434: ${E}`:""].filter(Boolean).join(" \u2022 ");return{name:c,slug:Ve(c),sku:x,description:v,composition:O,shortDescription:je,price:a,originalPrice:l,category:U,brand:E,volume:D,weight:w.\u0412\u0435\u0441||"",dimensions:G,material:w.\u041C\u0430\u0442\u0435\u0440\u0438\u0430\u043B||w["\u041C\u0430\u0442\u0435\u0440\u0438\u0430\u043B \u0447\u0430\u0448\u0438"]||"\u041F\u0412\u0425",color:w.\u0426\u0432\u0435\u0442||"\u0413\u043E\u043B\u0443\u0431\u043E\u0439",frameType:U==="frame-pools"?"\u041C\u0435\u0442\u0430\u043B\u043B\u0438\u0447\u0435\u0441\u043A\u0438\u0439":null,pumpType:w["\u0422\u0438\u043F \u043D\u0430\u0441\u043E\u0441\u0430"]||"\u041A\u0430\u0440\u0442\u0440\u0438\u0434\u0436\u043D\u044B\u0439",shape:w.\u0424\u043E\u0440\u043C\u0430||(c.toLowerCase().includes("\u043A\u0440\u0443\u0433")?"\u041A\u0440\u0443\u0433\u043B\u044B\u0439":"\u041F\u0440\u044F\u043C\u043E\u0443\u0433\u043E\u043B\u044C\u043D\u044B\u0439"),installationType:"\u041D\u0430\u0437\u0435\u043C\u043D\u044B\u0439",countryOrigin:w["\u0421\u0442\u0440\u0430\u043D\u0430-\u043F\u0440\u043E\u0438\u0437\u0432\u043E\u0434\u0438\u0442\u0435\u043B\u044C"]||"\u041A\u0438\u0442\u0430\u0439",imageUrl:k,images:[],specifications:JSON.stringify(w),inStock:!0,isPopular:!1,isNew:!1,discount:0,rating:"4.5",reviewCount:Math.floor(Math.random()*50)+10}}catch(s){throw console.error(`Error parsing ${o}:`,s),s}}var be="admin",we="aquapool2025",$=(o,s,r)=>{let t=o.headers.authorization;if(!t||!t.startsWith("Basic "))return s.status(401).json({message:"\u041D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u0430 \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u044F"});let e=Buffer.from(t.slice(6),"base64").toString(),[i,c]=e.split(":");if(i!==be||c!==we)return s.status(401).json({message:"\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043B\u043E\u0433\u0438\u043D \u0438\u043B\u0438 \u043F\u0430\u0440\u043E\u043B\u044C"});r()};async function $e(o){return o.get("/api/products",async(r,t)=>{try{let e={category:r.query.category,brand:r.query.brand,minPrice:r.query.minPrice?parseFloat(r.query.minPrice):void 0,maxPrice:r.query.maxPrice?parseFloat(r.query.maxPrice):void 0,inStock:r.query.inStock?r.query.inStock==="true":void 0,search:r.query.search,poolType:r.query.poolType,volumeRange:r.query.volumeRange,shape:r.query.shape,material:r.query.material,dimensions:r.query.dimensions},i=await f.getProducts(e);t.json(i)}catch{t.status(500).json({message:"Failed to fetch products"})}}),o.get("/api/products/popular",async(r,t)=>{try{let e=await f.getPopularProducts();t.json(e)}catch{t.status(500).json({message:"Failed to fetch popular products"})}}),o.get("/api/search/suggestions",async(r,t)=>{try{let e=r.query.q;if(!e||e.length<2)return t.json([]);let i=decodeURIComponent(e),c=await f.getSearchSuggestions(i);t.json(c)}catch(e){console.error("Error fetching search suggestions:",e),t.status(500).json({message:"Failed to fetch suggestions"})}}),o.get("/api/products/:identifier",async(r,t)=>{try{let e=r.params.identifier,i;if(/^\d+$/.test(e)){let c=parseInt(e);i=await f.getProduct(c)}else i=await f.getProductBySlug(e);if(!i)return t.status(404).json({message:"Product not found"});t.json(i)}catch{t.status(500).json({message:"Failed to fetch product"})}}),o.get("/api/categories",async(r,t)=>{try{let e=await f.getCategories();t.json(e)}catch{t.status(500).json({message:"Failed to fetch categories"})}}),o.get("/api/categories/main",async(r,t)=>{try{let e=await f.getMainCategories();t.json(e)}catch{t.status(500).json({message:"Failed to fetch main categories"})}}),o.get("/api/categories/:id/subcategories",async(r,t)=>{try{let e=parseInt(r.params.id),i=await f.getSubcategories(e);t.json(i)}catch{t.status(500).json({message:"Failed to fetch subcategories"})}}),o.get("/api/categories/:slug",async(r,t)=>{try{let e=await f.getCategory(r.params.slug);if(!e)return t.status(404).json({message:"Category not found"});t.json(e)}catch{t.status(500).json({message:"Failed to fetch category"})}}),o.get("/api/categories/:slug/stats",async(r,t)=>{try{let e=await f.getCategoryStats(r.params.slug);t.json(e||{count:0,minPrice:0})}catch(e){console.error("Error fetching category stats:",e),t.status(500).json({message:"Failed to fetch category stats"})}}),o.post("/api/orders",async(r,t)=>{try{let e=te.parse(r.body),i=await f.createOrder(e);try{await Se({orderId:i.id,customerName:i.customerName,phone:i.customerPhone,email:i.customerEmail||"\u041D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D",deliveryAddress:i.deliveryAddress||"\u041D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D",items:JSON.parse(i.items),totalAmount:i.totalAmount,paymentMethod:i.paymentMethod,deliveryMethod:i.deliveryMethod}),console.log(`\u0423\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u043E \u0437\u0430\u043A\u0430\u0437\u0435 #${i.id} \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u043E \u0432 Telegram`)}catch(c){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043E\u0442\u043F\u0440\u0430\u0432\u043A\u0438 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F \u043E \u0437\u0430\u043A\u0430\u0437\u0435 \u0432 Telegram:",c)}t.status(201).json(i)}catch(e){t.status(400).json({message:"Invalid order data",error:e})}}),o.get("/api/orders/:id",async(r,t)=>{try{let e=parseInt(r.params.id);if(isNaN(e))return t.status(400).json({message:"Invalid order ID"});let i=await f.getOrder(e);if(!i)return t.status(404).json({message:"Order not found"});t.json(i)}catch(e){t.status(500).json({message:"Server error",error:e})}}),o.post("/api/consultations",async(r,t)=>{try{let e=re.parse(r.body),i=await f.createConsultation(e);try{await he({name:i.name,phone:i.phone,message:i.message||"\u0417\u0430\u043F\u0440\u043E\u0441 \u043A\u043E\u043D\u0441\u0443\u043B\u044C\u0442\u0430\u0446\u0438\u0438"}),console.log(`\u0417\u0430\u044F\u0432\u043A\u0430 \u043D\u0430 \u043A\u043E\u043D\u0441\u0443\u043B\u044C\u0442\u0430\u0446\u0438\u044E \u043E\u0442 ${i.name} \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0430 \u0432 Telegram`)}catch(c){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043E\u0442\u043F\u0440\u0430\u0432\u043A\u0438 \u0437\u0430\u044F\u0432\u043A\u0438 \u043D\u0430 \u043A\u043E\u043D\u0441\u0443\u043B\u044C\u0442\u0430\u0446\u0438\u044E \u0432 Telegram:",c)}t.status(201).json(i)}catch(e){t.status(400).json({message:"Invalid consultation data",error:e})}}),o.get("/api/telegram/test",async(r,t)=>{try{let e=await X();t.json(e)}catch(e){t.status(500).json({success:!1,message:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0442\u0435\u0441\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F Telegram \u0431\u043E\u0442\u0430",error:e})}}),o.get("/api/telegram/admins",(r,t)=>{try{let e=Pe();t.json(e)}catch(e){t.status(500).json({success:!1,message:"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u0438\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u0438 \u043E\u0431 \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0430\u0445",error:e})}}),o.post("/api/admin/login",(r,t)=>{let{login:e,password:i}=r.body;if(e===be&&i===we){let c=Buffer.from(`${e}:${i}`).toString("base64");t.json({success:!0,message:"\u0410\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u044F \u0443\u0441\u043F\u0435\u0448\u043D\u0430",token:`Basic ${c}`})}else t.status(401).json({success:!1,message:"\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043B\u043E\u0433\u0438\u043D \u0438\u043B\u0438 \u043F\u0430\u0440\u043E\u043B\u044C"})}),o.post("/api/admin/products",$,async(r,t)=>{try{let e=ee.parse(r.body),i=await f.createProduct(e);t.status(201).json(i)}catch(e){t.status(400).json({message:"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u0438 \u0442\u043E\u0432\u0430\u0440\u0430",error:e})}}),o.put("/api/admin/products/:id",$,async(r,t)=>{try{let e=parseInt(r.params.id),i=r.body,c=await f.updateProduct(e,i);if(!c)return t.status(404).json({message:"\u0422\u043E\u0432\u0430\u0440 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"});t.json(c)}catch(e){t.status(400).json({message:"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438 \u0442\u043E\u0432\u0430\u0440\u0430",error:e})}}),o.delete("/api/admin/products/:id",$,async(r,t)=>{try{let e=parseInt(r.params.id);if(!await f.deleteProduct(e))return t.status(404).json({message:"\u0422\u043E\u0432\u0430\u0440 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"});t.json({message:"\u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0435\u043D \u0443\u0441\u043F\u0435\u0448\u043D\u043E"})}catch(e){t.status(500).json({message:"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u0438 \u0442\u043E\u0432\u0430\u0440\u0430",error:e})}}),o.post("/api/admin/products/update-price",$,async(r,t)=>{try{let{sku:e,price:i,originalPrice:c}=r.body;if(!e||!i)return t.status(400).json({message:"SKU \u0438 \u0446\u0435\u043D\u0430 \u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u044B"});let a=await f.updateProductPriceBySku(e,i,c);if(!a)return t.status(404).json({message:"\u0422\u043E\u0432\u0430\u0440 \u0441 \u0443\u043A\u0430\u0437\u0430\u043D\u043D\u044B\u043C SKU \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"});t.json({success:!0,message:`\u0426\u0435\u043D\u0430 \u0442\u043E\u0432\u0430\u0440\u0430 ${e} \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430`,product:a})}catch(e){t.status(500).json({message:"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438 \u0446\u0435\u043D\u044B",error:e})}}),o.post("/api/admin/parse-products",$,async(r,t)=>{try{let{urls:e}=r.body;if(!Array.isArray(e))return t.status(400).json({message:"URLs must be an array"});let i=[],c=[];for(let a=0;a<e.length;a++){let l=e[a];try{console.log(`Parsing product ${a+1}/${e.length}: ${l}`);let S=await Ge(l);i.push(S),await new Promise(j=>setTimeout(j,500))}catch(S){console.error(`Error parsing ${l}:`,S),c.push({url:l,error:"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430: "+(S instanceof Error?S.message:String(S))})}}t.json({success:!0,products:i,errors:c})}catch(e){console.error("Error parsing products:",e),t.status(500).json({message:"Failed to parse products"})}}),o.post("/api/admin/import-products",$,async(r,t)=>{try{let{products:e}=r.body;if(!Array.isArray(e))return t.status(400).json({message:"Products must be an array"});let i=[],c=[];for(let a=0;a<e.length;a++)try{let l=e[a];if(!l.name)throw new Error("Product name is required");console.log(`Creating product: ${l.name} with price: ${l.price}, originalPrice: ${l.originalPrice}`);let S=await f.createProduct(l);console.log(`Created product with id: ${S.id}, price: ${S.price}, originalPrice: ${S.originalPrice}`),i.push(S)}catch(l){c.push({index:a,product:e[a]?.name||`Product ${a}`,error:l instanceof Error?l.message:String(l)})}t.json({success:!0,imported:i.length,errorCount:c.length,results:i,errorsList:c})}catch(e){console.error("Error importing products:",e),t.status(500).json({message:"Failed to import products"})}}),o.get("/api/admin/settings",$,async(r,t)=>{try{let e=await f.getSiteSettings();t.json(e)}catch(e){console.error("Error fetching site settings:",e),t.status(500).json({message:"Failed to fetch settings"})}}),o.post("/api/admin/settings",$,async(r,t)=>{try{let e=await f.createSiteSetting(r.body);t.json(e)}catch(e){console.error("Error creating site setting:",e),t.status(500).json({message:"Failed to create setting"})}}),o.put("/api/admin/settings/:id",$,async(r,t)=>{try{let e=parseInt(r.params.id),i=await f.updateSiteSetting(e,r.body);t.json(i)}catch(e){console.error("Error updating site setting:",e),t.status(500).json({message:"Failed to update setting"})}}),o.delete("/api/admin/settings/:id",$,async(r,t)=>{try{let e=parseInt(r.params.id);await f.deleteSiteSetting(e),t.json({success:!0})}catch(e){console.error("Error deleting site setting:",e),t.status(500).json({message:"Failed to delete setting"})}}),o.get("/api/tracking-settings",async(r,t)=>{try{let e=await f.getActiveTrackingSettings();t.json(e)}catch(e){console.error("Error fetching tracking settings:",e),t.status(500).json({message:"Failed to fetch tracking settings"})}}),o.get("/api/admin/telegram-admins",$,async(r,t)=>{try{let e=await f.getTelegramAdmins();t.json(e)}catch(e){console.error("Error fetching telegram admins:",e),t.status(500).json({message:"Failed to fetch telegram admins"})}}),o.post("/api/admin/telegram-admins",$,async(r,t)=>{try{let e=await f.createTelegramAdmin(r.body);t.json(e)}catch(e){console.error("Error creating telegram admin:",e),e.code==="23505"?t.status(400).json({message:"\u042D\u0442\u043E\u0442 Telegram ID \u0443\u0436\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D"}):t.status(500).json({message:"Failed to create telegram admin"})}}),o.delete("/api/admin/telegram-admins/:id",$,async(r,t)=>{try{let e=parseInt(r.params.id);await f.deleteTelegramAdmin(e)?t.json({success:!0}):t.status(404).json({message:"Admin not found"})}catch(e){console.error("Error deleting telegram admin:",e),t.status(500).json({message:"Failed to delete telegram admin"})}}),o.patch("/api/admin/telegram-admins/:id/toggle",$,async(r,t)=>{try{let e=parseInt(r.params.id),{isActive:i}=r.body,c=await f.toggleTelegramAdmin(e,i);t.json(c)}catch(e){console.error("Error toggling telegram admin:",e),t.status(500).json({message:"Failed to toggle telegram admin"})}}),Ke(o)}import Xe from"express";import Ae from"fs";import ce from"path";import{createServer as et,createLogger as tt}from"vite";import{defineConfig as Ze}from"vite";import Qe from"@vitejs/plugin-react";import K from"path";import Ye from"@replit/vite-plugin-runtime-error-modal";var xe=Ze({plugins:[Qe(),Ye(),...process.env.NODE_ENV!=="production"&&process.env.REPL_ID!==void 0?[await import("@replit/vite-plugin-cartographer").then(o=>o.cartographer())]:[]],resolve:{alias:{"@":K.resolve(import.meta.dirname,"client","src"),"@shared":K.resolve(import.meta.dirname,"shared"),"@assets":K.resolve(import.meta.dirname,"attached_assets")}},root:K.resolve(import.meta.dirname,"client"),build:{outDir:K.resolve(import.meta.dirname,"dist/public"),emptyOutDir:!0},server:{fs:{strict:!0,deny:["**/.*"]}}});import{nanoid as rt}from"nanoid";var ke=tt();function ve(o,s="express"){let r=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});console.log(`${r} [${s}] ${o}`)}async function Ce(o,s){let r={middlewareMode:!0,hmr:{server:s},allowedHosts:!0},t=await et({...xe,configFile:!1,customLogger:{...ke,error:(e,i)=>{ke.error(e,i),process.exit(1)}},server:r,appType:"custom"});o.use(t.middlewares),o.use("*",async(e,i,c)=>{let a=e.originalUrl;try{let l=ce.resolve(import.meta.dirname,"..","client","index.html"),S=await Ae.promises.readFile(l,"utf-8");S=S.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${rt()}"`);let j=await t.transformIndexHtml(a,S);i.status(200).set({"Content-Type":"text/html"}).end(j)}catch(l){t.ssrFixStacktrace(l),c(l)}})}function Te(o){let s=ce.resolve(import.meta.dirname,"public");if(!Ae.existsSync(s))throw new Error(`Could not find the build directory: ${s}, make sure to build the client first`);o.use(Xe.static(s)),o.use("*",(r,t)=>{t.sendFile(ce.resolve(s,"index.html"))})}var I=W();I.use(W.json({limit:"50mb"}));I.use(W.urlencoded({extended:!1,limit:"50mb"}));I.use("/attached_assets",W.static("attached_assets"));I.use(W.static(".",{dotfiles:"allow",setHeaders:(o,s)=>{s.includes("yandex_")&&s.endsWith(".html")&&o.setHeader("Content-Type","text/html; charset=UTF-8")}}));I.use((o,s,r)=>{let t=Date.now(),e=o.path,i,c=s.json;s.json=function(a,...l){return i=a,c.apply(s,[a,...l])},s.on("finish",()=>{let a=Date.now()-t;if(e.startsWith("/api")){let l=`${o.method} ${e} ${s.statusCode} in ${a}ms`;i&&(l+=` :: ${JSON.stringify(i)}`),l.length>80&&(l=l.slice(0,79)+"\u2026"),ve(l)}}),r()});(async()=>{I.get("/yandex_816365dd176df39c.html",(r,t)=>{t.setHeader("Content-Type","text/html; charset=UTF-8"),t.send(`<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>
    <body>Verification: 816365dd176df39c</body>
</html>`)});let o=await $e(I);I.use((r,t,e,i)=>{let c=r.status||r.statusCode||500,a=r.message||"Internal Server Error";throw e.status(c).json({message:a}),r}),I.get("env")==="development"?await Ce(I,o):Te(I);let s=5e3;o.listen({port:s,host:"0.0.0.0",reusePort:!0},()=>{console.log(`\u{1F680} AquaPool Production Server \u0437\u0430\u043F\u0443\u0449\u0435\u043D \u043D\u0430 \u043F\u043E\u0440\u0442\u0443 ${s}`),console.log("\u{1F4CA} \u0424\u0443\u043D\u043A\u0446\u0438\u043E\u043D\u0430\u043B: 300+ \u0442\u043E\u0432\u0430\u0440\u043E\u0432, \u043A\u043E\u0440\u0437\u0438\u043D\u0430, \u0430\u0434\u043C\u0438\u043D-\u043F\u0430\u043D\u0435\u043B\u044C"),console.log("\u{1F4AC} WhatsApp \u0438\u043D\u0442\u0435\u0433\u0440\u0430\u0446\u0438\u044F \u0430\u043A\u0442\u0438\u0432\u043D\u0430"),console.log("\u{1F4C8} Yandex.Metrika \u0430\u043D\u0430\u043B\u0438\u0442\u0438\u043A\u0430 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0430"),console.log("\u{1F510} \u0410\u0434\u043C\u0438\u043D-\u043F\u0430\u043D\u0435\u043B\u044C: /admin (admin / aquapool2025)"),console.log("\u{1F310} \u0413\u043E\u0442\u043E\u0432 \u043A \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u044E \u0434\u043E\u043C\u0435\u043D\u0430 aquapool-shop.ru"),X().then(r=>{r.success?console.log("\u2705 Telegram \u0431\u043E\u0442 \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D"):console.log("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u044F \u043A Telegram \u0431\u043E\u0442\u0443:",r.error)}).catch(r=>{console.log("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0442\u0435\u0441\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F Telegram \u0431\u043E\u0442\u0430:",r)})})})();
