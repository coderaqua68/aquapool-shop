import { Pool, neonConfig } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-serverless';
import { products } from './shared/schema.ts';
import { eq, like } from 'drizzle-orm';
import ws from 'ws';

// Настройка WebSocket для работы с Neon
neonConfig.webSocketConstructor = ws;

// Данные для обновления цен из прикрепленного файла
const priceUpdates = [
  {
    name: "Бассейн Гигабасс 7 х 3.5 х 1.5 м, морозоустойчивый вкапываемый (скиммер+форсунка) арт. ТМ607 - платина",
    originalPrice: 165000,
    price: 143625
  },
  {
    name: "Бассейн Лагуна 5 х 1.25 м (полная комплектация) арт. 50012 - платина",
    originalPrice: 90000,
    price: 76875
  },
  {
    name: "Бассейн Гигабасс 3 х 2 х 1.5 м, морозоустойчивый вкапываемый (скиммер+форсунка) арт. ТМ868 - платина",
    originalPrice: 71250,
    price: 60375
  },
  {
    name: "Бассейн Гигабасс 4 х 2 х 1.5 м, морозоустойчивый вкапываемый (скиммер+форсунка) арт. ТМ869 - платина",
    originalPrice: 82500,
    price: 73875
  },
  {
    name: "Бассейн Гигабасс 4 х 3 х 1.5 м, морозоустойчивый вкапываемый (скиммер+форсунка) арт. ТМ870 - платина",
    originalPrice: 97500,
    price: 83250
  },
  {
    name: "Бассейн Гигабасс 5 х 2 х 1.5 м, морозоустойчивый вкапываемый (скиммер+форсунка) арт. ТМ871 - платина",
    originalPrice: 101250,
    price: 90000
  },
  {
    name: "Бассейн Гигабасс 5 х 3 х 1.5 м, морозоустойчивый вкапываемый (скиммер+форсунка) арт. ТМ605 - платина",
    originalPrice: 120000,
    price: 108375
  },
  {
    name: "Бассейн Гигабасс 6 х 3 х 1.5 м, морозоустойчивый вкапываемый (скиммер+форсунка) арт. ТМ606 - платина",
    originalPrice: 135000,
    price: 120750
  },
  {
    name: "Бассейн Гигабасс 8 х 3 х 1.5 м, морозоустойчивый вкапываемый (скиммер+форсунка) арт. ТМ876 - платина",
    originalPrice: 172500,
    price: 150000
  },
  {
    name: "Бассейн Лагуна 3 х 2 х 1.25 м, морозоустойчивый (скиммер+форсунка) арт. 30020001",
    originalPrice: 48750,
    price: 39000
  },
  {
    name: "Бассейн Лагуна 4 х 2 х 1.25 м, морозоустойчивый (скиммер+форсунка) арт. 40020001",
    originalPrice: 56250,
    price: 47250
  },
  {
    name: "Бассейн Лагуна 4 х 3 х 1.25 м, морозоустойчивый (скиммер+форсунка) арт. 40030001",
    originalPrice: 63750,
    price: 52500
  },
  {
    name: "Бассейн Лагуна 5 х 2.5 х 1.25 м, морозоустойчивый (скиммер+форсунка) арт. 50025001",
    originalPrice: 67500,
    price: 57375
  },
  {
    name: "Бассейн Лагуна 5 х 3 х 1.25 м, морозоустойчивый (скиммер+форсунка) арт. 50030001",
    originalPrice: 71250,
    price: 59625
  },
  {
    name: "Бассейн Лагуна 6 х 3 х 1.25 м, морозоустойчивый (скиммер+форсунка) арт. 60030001",
    originalPrice: 78750,
    price: 70125
  },
  {
    name: "Бассейн Лагуна 6 х 3.5 х 1.25 м, морозоустойчивый (скиммер+форсунка) арт. 60035001",
    originalPrice: 82500,
    price: 72750
  },
  {
    name: "Бассейн Лагуна 6 х 4 х 1.25 м, морозоустойчивый (скиммер+форсунка) арт. 60040001",
    originalPrice: 86250,
    price: 74625
  },
  {
    name: "Бассейн Лагуна 5 х 1.25 м (полная комплектация) арт. 50040 / 3 - дерево",
    originalPrice: 99000,
    price: 91875
  },
  {
    name: "Бассейн Лагуна 4 х 1.25 м (полная комплектация) арт. 40040 / 3 - дерево",
    originalPrice: 75000,
    price: 73125
  },
  {
    name: "Бассейн Лагуна 3.5 х 1.25 м (полная комплектация) арт. 35040 / 3 - дерево",
    originalPrice: 77250,
    price: 67500
  },
  {
    name: "Бассейн Лагуна 3 х 1.25 м (полная комплектация) арт. 30040 / 3 - дерево",
    originalPrice: 69000,
    price: 59625
  },
  {
    name: "Бассейн Лагуна 5.5 х 1.25 м (полная комплектация) арт. 55012 / 3 - платина",
    originalPrice: 103500,
    price: 95250
  },
  {
    name: "Бассейн Лагуна 4.5 х 1.25 м (полная комплектация) арт. 45012 / 3 - платина",
    originalPrice: 84000,
    price: 78000
  },
  {
    name: "Бассейн Лагуна 4 х 1.25 м (полная комплектация) арт. 40012 / 3 - платина",
    originalPrice: 78750,
    price: 68625
  },
  {
    name: "Бассейн Лагуна 3.5 х 1.25 м (полная комплектация) арт. 35012 / 3 - платина",
    originalPrice: 73500,
    price: 63375
  },
  {
    name: "Бассейн Лагуна 3 х 1.25 м (полная комплектация) арт. 30012 / 3 - платина",
    originalPrice: 63750,
    price: 55875
  },
  {
    name: "Бассейн Лагуна 5.5 х 1.25 м (полная комплектация) арт. 55014 / 3 - коричневый",
    originalPrice: 108750,
    price: 95250
  },
  {
    name: "Бассейн Лагуна 5 х 1.25 м (полная комплектация) арт. 50014 / 3 - коричневый",
    originalPrice: 97500,
    price: 86625
  },
  {
    name: "Бассейн Лагуна 4.5 х 1.25 м (полная комплектация) арт. 45014 / 3 - коричневый",
    originalPrice: 90000,
    price: 78000
  },
  {
    name: "Бассейн Лагуна 4 х 1.25 м (полная комплектация) арт. 40014 / 3 - коричневый",
    originalPrice: 78750,
    price: 68625
  },
  {
    name: "Бассейн Лагуна 3.5 х 1.25 м (полная комплектация) арт. 35014 / 3 - коричневый",
    originalPrice: 73500,
    price: 63375
  },
  {
    name: "Бассейн Лагуна 3 х 1.25 м (полная комплектация) арт. 30014 / 3 - коричневый",
    originalPrice: 63750,
    price: 55875
  },
  {
    name: "Бассейн Лагуна 4 х 1.25 м (полная комплектация) арт. 40040 / 2 - дерево",
    originalPrice: 82500,
    price: 73125
  },
  {
    name: "Бассейн Лагуна 3.5 х 1.25 м (полная комплектация) арт. 35040 / 2 - дерево",
    originalPrice: 77250,
    price: 67500
  },
  {
    name: "Бассейн Лагуна 5.5 х 1.25 м (полная комплектация) арт. 55012 / 2 - платина",
    originalPrice: 103500,
    price: 95250
  },
  {
    name: "Бассейн Лагуна 4.5 х 1.25 м (полная комплектация) арт. 45012 / 2 - платина",
    originalPrice: 84000,
    price: 78000
  },
  {
    name: "Бассейн Лагуна 4 х 1.25 м (полная комплектация) арт. 40012 / 2 - платина",
    originalPrice: 78750,
    price: 68625
  },
  {
    name: "Бассейн Лагуна 3.5 х 1.25 м (полная комплектация) арт. 35012 / 2 - платина",
    originalPrice: 73500,
    price: 63375
  },
  {
    name: "Бассейн Гигабасс 3 х 1.5 м, морозоустойчивый вкапываемый (полный комплект) арт. ТМ595-01 - платина",
    originalPrice: 97500,
    price: 80625
  },
  {
    name: "Бассейн Гигабасс 3.5 х 1.5 м, морозоустойчивый вкапываемый (полный комплект) арт. ТМ596-01 - платина",
    originalPrice: 112500,
    price: 93000
  },
  {
    name: "Бассейн Гигабасс 4 х 1.5 м, морозоустойчивый вкапываемый (полный комплект) арт. ТМ597-01 - платина",
    originalPrice: 120000,
    price: 103500
  },
  {
    name: "Бассейн Гигабасс 4.5 х 1.5 м, морозоустойчивый вкапываемый (полный комплект) арт. ТМ598-01 - платина",
    originalPrice: 135000,
    price: 115500
  },
  {
    name: "Бассейн Гигабасс 5 х 1.5 м, морозоустойчивый вкапываемый (полный комплект) арт. ТМ599-01 - платина",
    originalPrice: 150000,
    price: 129375
  },
  {
    name: "Бассейн Гигабасс 6 х 1.5 м, морозоустойчивый вкапываемый (полный комплект) арт. ТМ600-01 - платина",
    originalPrice: 180000,
    price: 153750
  },
  {
    name: "Бассейн Лагуна 5.5 х 1.25 м (полная комплектация) арт. 55014 / 2 - коричневый",
    originalPrice: 108750,
    price: 95250
  },
  {
    name: "Бассейн Лагуна 4.5 х 1.25 м (полная комплектация) арт. 45014 / 2 - коричневый",
    originalPrice: 90000,
    price: 78000
  },
  {
    name: "Бассейн Лагуна 5.5 х 1.25 м (полная комплектация) арт. 55040 / 1 - дерево",
    originalPrice: 105000,
    price: 89625
  },
  {
    name: "Бассейн Лагуна 5 х 1.25 м (полная комплектация) арт. 50040 / 1 - дерево",
    originalPrice: 93750,
    price: 82125
  },
  {
    name: "Бассейн Лагуна 4.5 х 1.25 м (полная комплектация) арт. 45040 / 1 - дерево",
    originalPrice: 86250,
    price: 74250
  },
  {
    name: "Бассейн Лагуна 4 х 1.25 м (полная комплектация) арт. 40040 / 1 - дерево",
    originalPrice: 78750,
    price: 66375
  },
  {
    name: "Бассейн Лагуна 3.5 х 1.25 м (полная комплектация) арт. 35040 / 1 - дерево",
    originalPrice: 75000,
    price: 61875
  },
  {
    name: "Бассейн Лагуна 3 х 1.25 м (полная комплектация) арт. 30040 / 1 - дерево",
    originalPrice: 67500,
    price: 55500
  },
  {
    name: "Бассейн Лагуна 5.5 х 1.25 м (полная комплектация) арт. 55012 / 1 - платина",
    originalPrice: 97500,
    price: 83250
  },
  {
    name: "Бассейн Лагуна 5 х 1.25 м (полная комплектация) арт. 50012 / 1 - платина",
    originalPrice: 90000,
    price: 76875
  },
  {
    name: "Бассейн Лагуна 4.5 х 1.25 м (полная комплектация) арт. 45012 / 1 - платина",
    originalPrice: 78750,
    price: 69375
  },
  {
    name: "Бассейн Лагуна 4 х 1.25 м (полная комплектация) арт. 40012 / 1 - платина",
    originalPrice: 75000,
    price: 61875
  },
  {
    name: "Бассейн Лагуна 3.5 х 1.25 м (полная комплектация) арт. 35012 / 1 - платина",
    originalPrice: 67500,
    price: 57750
  },
  {
    name: "Бассейн Лагуна 3 х 1.25 м (полная комплектация) арт. 30012 / 1 - платина",
    originalPrice: 60000,
    price: 51750
  },
  {
    name: "Бассейн Лагуна 5.5 х 1.25 м (полная комплектация) арт. 55014 / 1 - коричневый",
    originalPrice: 97500,
    price: 82500
  },
  {
    name: "Бассейн Лагуна 5 х 1.25 м (полная комплектация) арт. 50014 / 1 - коричневый",
    originalPrice: 90000,
    price: 76875
  }
];

async function newBatchPriceUpdate() {
  if (!process.env.DATABASE_URL) {
    throw new Error('DATABASE_URL environment variable is required');
  }

  const pool = new Pool({ connectionString: process.env.DATABASE_URL });
  const db = drizzle(pool);

  console.log('🚀 Начинаем массовое обновление цен товаров...');
  
  let updatedCount = 0;
  let notFoundCount = 0;
  let errors = [];

  for (const update of priceUpdates) {
    try {
      // Ищем товар по точному названию
      const existingProducts = await db
        .select()
        .from(products)
        .where(eq(products.name, update.name));
      
      if (existingProducts.length > 0) {
        const product = existingProducts[0];
        
        // Обновляем цены
        await db
          .update(products)
          .set({
            price: update.price.toString(),
            originalPrice: update.originalPrice.toString()
          })
          .where(eq(products.id, product.id));
        
        console.log(`✅ Обновлен товар: ${product.name}`);
        console.log(`   Старая цена: ${product.price} → Новая цена: ${update.price}`);
        console.log(`   Старая цена до скидки: ${product.originalPrice} → Новая цена до скидки: ${update.originalPrice}`);
        updatedCount++;
      } else {
        console.log(`❌ Товар не найден: ${update.name}`);
        notFoundCount++;
      }
    } catch (error) {
      console.error(`❌ Ошибка при обновлении товара "${update.name}":`, error.message);
      errors.push({ name: update.name, error: error.message });
    }
  }

  console.log('\n📊 Результаты массового обновления:');
  console.log(`✅ Обновлено товаров: ${updatedCount}`);
  console.log(`❌ Товаров не найдено: ${notFoundCount}`);
  console.log(`📝 Всего обработано: ${priceUpdates.length}`);
  
  if (errors.length > 0) {
    console.log(`⚠️ Ошибок: ${errors.length}`);
  }

  await pool.end();
}

// Запускаем обновление
newBatchPriceUpdate()
  .then(() => {
    console.log('🎉 Массовое обновление цен завершено успешно!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('💥 Ошибка при массовом обновлении цен:', error);
    process.exit(1);
  });