#!/bin/bash

echo "üöÄ –°–æ–∑–¥–∞–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–π –¥–µ–ø–ª–æ–π AquaPool..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
set -e

# 1. –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã..."
rm -rf dist server/index.js

# 2. –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫–∏
mkdir -p server

# 3. –°–æ–±–∏—Ä–∞–µ–º backend (–±—ã—Å—Ç—Ä–æ)
echo "üì¶ –°–æ–±–∏—Ä–∞–µ–º backend..."
npx esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outfile=server/index.js

# 4. –°–æ–±–∏—Ä–∞–µ–º frontend (—Ç–µ—Ä–ø–µ–ª–∏–≤–æ –∂–¥–µ–º)
echo "üé® –°–æ–±–∏—Ä–∞–µ–º frontend (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 2-3 –º–∏–Ω—É—Ç—ã)..."
echo "‚òï –ú–æ–∂–µ—Ç–µ –ø–æ–ø–∏—Ç—å –∫–æ—Ñ–µ, –ø–æ–∫–∞ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è..."

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º timeout
timeout 300 npm run build:frontend || {
    echo "‚ö†Ô∏è  –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∑–∞–Ω–∏–º–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏"
    echo "üîÑ –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±..."
    npx vite build --mode production
}

# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å
if [ -f "server/index.js" ] && [ -d "dist" ]; then
    echo "‚úÖ –î–µ–ø–ª–æ–π –≥–æ—Ç–æ–≤!"
    echo "üìÅ Backend: server/index.js"
    echo "üìÅ Frontend: dist/"
    echo ""
    echo "üöÄ –î–ª—è –∑–∞–ø—É—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
    echo "   NODE_ENV=production node server/index.js"
else
    echo "‚ùå –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫"
    exit 1
fi