import { Pool, neonConfig } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-serverless';
import { products } from './shared/schema.ts';
import { eq } from 'drizzle-orm';
import ws from 'ws';

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° WebSocket Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Neon
neonConfig.webSocketConstructor = ws;

// Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ†ÐµÐ½ Ð¸Ð· Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°
const lagunaUpdates = [
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 50040 - Ð´ÐµÑ€ÐµÐ²Ð¾",
    originalPrice: 93750,
    price: 82125
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 4.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 45014 / 1 - ÐºÐ¾Ñ€Ð¸Ñ‡Ð½ÐµÐ²Ñ‹Ð¹", 
    originalPrice: 82500,
    price: 69375
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 4 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 40014 / 1 - ÐºÐ¾Ñ€Ð¸Ñ‡Ð½ÐµÐ²Ñ‹Ð¹",
    originalPrice: 75000,
    price: 61875
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 3.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 35014 / 1 - ÐºÐ¾Ñ€Ð¸Ñ‡Ð½ÐµÐ²Ñ‹Ð¹",
    originalPrice: 67500,
    price: 57750
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 3 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 30014 / 1 - ÐºÐ¾Ñ€Ð¸Ñ‡Ð½ÐµÐ²Ñ‹Ð¹",
    originalPrice: 60000,
    price: 51750
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 5.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 55040 - Ð´ÐµÑ€ÐµÐ²Ð¾",
    originalPrice: 105000,
    price: 89625
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 4.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 45040 - Ð´ÐµÑ€ÐµÐ²Ð¾",
    originalPrice: 86250,
    price: 74250
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 4 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 40040 - Ð´ÐµÑ€ÐµÐ²Ð¾",
    originalPrice: 78750,
    price: 66375
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 3.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 35040 - Ð´ÐµÑ€ÐµÐ²Ð¾",
    originalPrice: 75000,
    price: 61875
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 3 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 30040 - Ð´ÐµÑ€ÐµÐ²Ð¾",
    originalPrice: 67500,
    price: 55500
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 2.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 25040 - Ð´ÐµÑ€ÐµÐ²Ð¾",
    originalPrice: 60000,
    price: 48375
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 5.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 55012 - Ð¿Ð»Ð°Ñ‚Ð¸Ð½Ð°",
    originalPrice: 97500,
    price: 83250
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 4.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 45012 - Ð¿Ð»Ð°Ñ‚Ð¸Ð½Ð°",
    originalPrice: 78750,
    price: 69375
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 4 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 40012 - Ð¿Ð»Ð°Ñ‚Ð¸Ð½Ð°",
    originalPrice: 75000,
    price: 61875
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 3.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 35012 - Ð¿Ð»Ð°Ñ‚Ð¸Ð½Ð°",
    originalPrice: 67500,
    price: 57750
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 3 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 30012 - Ð¿Ð»Ð°Ñ‚Ð¸Ð½Ð°",
    originalPrice: 60000,
    price: 51750
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 2.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 25012 - Ð¿Ð»Ð°Ñ‚Ð¸Ð½Ð°",
    originalPrice: 60000,
    price: 45375
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 5.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 55014 - ÐºÐ¾Ñ€Ð¸Ñ‡Ð½ÐµÐ²Ñ‹Ð¹",
    originalPrice: 97500,
    price: 83250
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 50014 - ÐºÐ¾Ñ€Ð¸Ñ‡Ð½ÐµÐ²Ñ‹Ð¹",
    originalPrice: 90000,
    price: 76875
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 4.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 45014 - ÐºÐ¾Ñ€Ð¸Ñ‡Ð½ÐµÐ²Ñ‹Ð¹",
    originalPrice: 82500,
    price: 69375
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 4 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 40014 - ÐºÐ¾Ñ€Ð¸Ñ‡Ð½ÐµÐ²Ñ‹Ð¹",
    originalPrice: 75000,
    price: 61875
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 3.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 35014 - ÐºÐ¾Ñ€Ð¸Ñ‡Ð½ÐµÐ²Ñ‹Ð¹",
    originalPrice: 67500,
    price: 57750
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 3 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 30014 - ÐºÐ¾Ñ€Ð¸Ñ‡Ð½ÐµÐ²Ñ‹Ð¹",
    originalPrice: 60000,
    price: 51750
  },
  {
    name: "Ð‘Ð°ÑÑÐµÐ¹Ð½ Ð›Ð°Ð³ÑƒÐ½Ð° 2.5 Ñ… 1.25 Ð¼ (Ð¿Ð¾Ð»Ð½Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð°Ñ†Ð¸Ñ) Ð°Ñ€Ñ‚. 25014 - ÐºÐ¾Ñ€Ð¸Ñ‡Ð½ÐµÐ²Ñ‹Ð¹",
    originalPrice: 60000,
    price: 45375
  }
];

async function updateLagunaPrices() {
  if (!process.env.DATABASE_URL) {
    throw new Error('DATABASE_URL environment variable is required');
  }

  const pool = new Pool({ connectionString: process.env.DATABASE_URL });
  const db = drizzle(pool);

  console.log('ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½ Ð´Ð»Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð›Ð°Ð³ÑƒÐ½Ð°...');
  
  let updatedCount = 0;
  let notFoundCount = 0;

  for (const update of lagunaUpdates) {
    try {
      // Ð˜Ñ‰ÐµÐ¼ Ñ‚Ð¾Ð²Ð°Ñ€ Ð¿Ð¾ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð¼Ñƒ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ
      const existingProducts = await db
        .select()
        .from(products)
        .where(eq(products.name, update.name));
      
      if (existingProducts.length > 0) {
        const product = existingProducts[0];
        
        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ†ÐµÐ½Ñ‹
        await db
          .update(products)
          .set({
            price: update.price.toString(),
            originalPrice: update.originalPrice.toString()
          })
          .where(eq(products.id, product.id));
        
        console.log(`âœ… ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½ Ñ‚Ð¾Ð²Ð°Ñ€: ${product.name}`);
        console.log(`   Ð¡Ñ‚Ð°Ñ€Ð°Ñ Ñ†ÐµÐ½Ð°: ${product.price} â†’ ÐÐ¾Ð²Ð°Ñ Ñ†ÐµÐ½Ð°: ${update.price}`);
        console.log(`   Ð¡Ñ‚Ð°Ñ€Ð°Ñ Ñ†ÐµÐ½Ð° Ð´Ð¾ ÑÐºÐ¸Ð´ÐºÐ¸: ${product.originalPrice} â†’ ÐÐ¾Ð²Ð°Ñ Ñ†ÐµÐ½Ð° Ð´Ð¾ ÑÐºÐ¸Ð´ÐºÐ¸: ${update.originalPrice}`);
        updatedCount++;
      } else {
        console.log(`âŒ Ð¢Ð¾Ð²Ð°Ñ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½: ${update.name}`);
        notFoundCount++;
      }
    } catch (error) {
      console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð° "${update.name}":`, error.message);
    }
  }

  console.log('\nðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ:');
  console.log(`âœ… ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²: ${updatedCount}`);
  console.log(`âŒ Ð¢Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾: ${notFoundCount}`);
  console.log(`ðŸ“ Ð’ÑÐµÐ³Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾: ${lagunaUpdates.length}`);

  await pool.end();
}

// Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
updateLagunaPrices()
  .then(() => {
    console.log('ðŸŽ‰ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('ðŸ’¥ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ Ñ†ÐµÐ½:', error);
    process.exit(1);
  });